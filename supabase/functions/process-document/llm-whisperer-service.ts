
// LLMWhisperer API integration service
export interface LLMWhispererRequest {
  file_url: string;
  output_format: 'markdown' | 'text';
  language: string;
  ocr: boolean;
}

export interface LLMWhispererResponse {
  status: string;
  result: {
    text?: string;
    markdown?: string;
    metadata: {
      pages: number;
      ocr_used: boolean;
      processing_time_ms: number;
      [key: string]: any;
    };
  };
  message?: string;
  whisper_hash?: string; // For async flow detection
}

export class LLMWhispererService {
  private apiKey: string;
  private baseUrl: string;

  constructor(apiKey: string, baseUrl: string = 'https://llmwhisperer-api.us-central.unstract.com/api/v2') {
    this.apiKey = apiKey;
    this.baseUrl = baseUrl;
  }

  async processDocument(fileUrl: string): Promise<LLMWhispererResponse> {
    console.log(`üîÑ Iniciando processamento LLMWhisperer para: ${fileUrl}`);
    
    // Debug: Verificar se a chave API est√° dispon√≠vel (mascarada)
    if (!this.apiKey) {
      console.error('‚ùå Chave API do LLMWhisperer n√£o encontrada');
      throw new Error('LLMWhisperer API key n√£o configurada');
    }
    
    const maskedKey = this.apiKey.substring(0, 8) + '...' + this.apiKey.substring(this.apiKey.length - 4);
    console.log(`üîë Usando chave API (mascarada): ${maskedKey}`);
    console.log(`üåê URL da API: ${this.baseUrl}/whisper`);
    
    const request: LLMWhispererRequest = {
      file_url: fileUrl,
      output_format: 'markdown',
      language: 'pt',
      ocr: true
    };

    console.log('üìã Payload LLMWhisperer:', JSON.stringify(request, null, 2));

    try {
      const controller = new AbortController();
      const timeoutId = setTimeout(() => {
        console.log('‚è∞ Timeout LLMWhisperer, abortando...');
        controller.abort();
      }, 180000); // 3 minutos timeout

      const headers = {
        'unstract-key': this.apiKey,
        'Content-Type': 'application/json',
        'Accept': 'application/json'
      };

      console.log('üì§ Headers da requisi√ß√£o (chave mascarada):', {
        'unstract-key': maskedKey,
        'Content-Type': 'application/json',
        'Accept': 'application/json'
      });

      const response = await fetch(`${this.baseUrl}/whisper`, {
        method: 'POST',
        headers,
        body: JSON.stringify(request),
        signal: controller.signal
      });

      clearTimeout(timeoutId);

      console.log(`üì• Status da resposta: ${response.status} ${response.statusText}`);
      console.log(`üìã Headers da resposta:`, Object.fromEntries(response.headers.entries()));

      if (!response.ok) {
        const errorText = await response.text();
        console.error(`‚ùå Erro LLMWhisperer: ${response.status} ${response.statusText}`);
        console.error(`üìÑ Resposta de erro: ${errorText}`);
        
        // Tentar parsear o erro para obter mais detalhes
        let errorDetails = errorText;
        try {
          const errorJson = JSON.parse(errorText);
          errorDetails = errorJson.message || errorText;
        } catch (parseError) {
          console.log('‚ö†Ô∏è N√£o foi poss√≠vel parsear a resposta de erro como JSON');
        }
        
        // Tratamento espec√≠fico para diferentes tipos de erro
        if (response.status === 401) {
          throw new Error(`Chave API inv√°lida ou inativa. Verifique sua assinatura do LLMWhisperer. Detalhes: ${errorDetails}`);
        } else if (response.status === 403) {
          throw new Error(`Acesso negado. Verifique as permiss√µes da sua chave API. Detalhes: ${errorDetails}`);
        } else if (response.status === 429) {
          throw new Error(`Limite de taxa excedido. Aguarde antes de tentar novamente. Detalhes: ${errorDetails}`);
        } else if (response.status >= 500) {
          throw new Error(`Erro interno do servidor LLMWhisperer. Tente novamente mais tarde. Detalhes: ${errorDetails}`);
        } else {
          throw new Error(`LLMWhisperer API error: ${response.status} ${response.statusText} - ${errorDetails}`);
        }
      }

      const result: LLMWhispererResponse = await response.json();
      console.log(`‚úÖ LLMWhisperer processamento conclu√≠do`);
      console.log(`üìä Metadados: ${JSON.stringify(result.result?.metadata || {}, null, 2)}`);
      
      // Check for async flow
      if (result.whisper_hash) {
        console.log(`üîÑ Detected async flow with whisper_hash: ${result.whisper_hash}`);
        console.log(`üìù Full response for debugging:`, JSON.stringify(result, null, 2));
      }

      if (!result.result?.markdown && !result.result?.text && !result.whisper_hash) {
        throw new Error('LLMWhisperer n√£o retornou texto v√°lido nem whisper_hash');
      }

      return result;

    } catch (error) {
      console.error('‚ùå Erro no processamento LLMWhisperer:', error);
      
      if (error.name === 'AbortError') {
        throw new Error('Timeout no processamento LLMWhisperer (3 minutos)');
      }
      
      // Re-throw com a mensagem original se j√° for um erro tratado
      throw error;
    }
  }
}
